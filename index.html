<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PorkEssentials Shop</title>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; color: #1c1e21; }
    header { background: #fff; border-bottom: 1px solid #ddd; padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.08); }
    .brand { font-size: 22px; font-weight: 800; color: #0077cc; }
    .btn { padding: 8px 14px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: 600; }
    .btn-primary { background: #0077cc; color: #fff; width: 100%; margin-top: 10px; }
    .btn-danger { background: #ff4d4f; color: #fff; padding: 4px 8px; font-size: 11px; border-radius: 4px; border: none; cursor: pointer; }
    .cart-count { background: #ff4d4f; color: #fff; border-radius: 10px; padding: 2px 8px; font-size: 11px; margin-left: 4px; }
    main { padding: 30px 20px; max-width: 1100px; margin: 0 auto; }
    .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .card { background: #fff; border-radius: 10px; padding: 16px; border: 1px solid #e0e0e0; cursor: pointer; transition: 0.2s; }
    .card:hover { border-color: #0077cc; }
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 2000; }
    .modal-box { background: #fff; padding: 24px; width: 90%; max-width: 400px; border-radius: 12px; }
    input { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
    .cart-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; font-size: 14px; }
  </style>
</head>
<body>

  <header>
    <div class="brand">PorkEssentials</div>
    <div style="display:flex; align-items:center; gap:15px;">
      <div id="status" style="font-size:11px;">Guest</div>
      <div id="viewCart" style="cursor:pointer; font-weight:600;">Cart<span class="cart-count" id="count">0</span></div>
      <button class="btn btn-primary" id="signupBtn" style="width:auto; margin:0">Join</button>
      <button class="btn" id="outBtn" style="display:none; background:#eee;">Logout</button>
    </div>
  </header>

  <main>
    <div class="shop-grid" id="grid"></div>
  </main>

  <div class="modal" id="authM">
    <div class="modal-box">
      <h3>Sign Up / Login</h3>
      <input type="email" id="email" placeholder="Email">
      <input type="password" id="pass" placeholder="Password">
      <button class="btn btn-primary" id="doAuth">Continue</button>
      <button onclick="document.getElementById('authM').style.display='none'" style="width:100%; margin-top:10px; background:none; border:none; cursor:pointer; color:#777;">Cancel</button>
    </div>
  </div>

  <div class="modal" id="cartM">
    <div class="modal-box">
      <h3>Your Cart</h3>
      <div id="list"></div>
      <h4 id="total" style="text-align:right; margin:15px 0;">Total: $0.00</h4>
      <button class="btn btn-primary" id="checkoutBtn" style="background:#28a745;">Go to Checkout</button>
      <button class="btn" onclick="document.getElementById('cartM').style.display='none'" style="margin-top:10px; background:#eee; width:100%;">Close</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendEmailVerification, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const config = {
      apiKey: "AIzaSyDx_P6m-wW68dfFfH3Yn8S6H3lXlNDg62g",
      authDomain: "project1-bad96.firebaseapp.com",
      databaseURL: "https://project1-bad96-default-rtdb.firebaseio.com",
      projectId: "project1-bad96",
      storageBucket: "project1-bad96.firebasestorage.app",
      messagingSenderId: "1061798946964",
      appId: "1:1061798946964:web:6d5e24253b4146af522c81"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const products = [
      { id: "p1", name: "Pro Gaming RGB Headset", price: 10.99, info: "7.1 Surround, Wireless." },
      { id: "p2", name: "Heavyweight Hoodie", price: 35.00, info: "100% Cotton, Black." },
      { id: "p3", name: "Matte Ceramic Mug", price: 12.00, info: "15oz minimalist design." },
      { id: "p4", name: "Precision Mouse", price: 25.00, info: "16k DPI, RGB zones." },
      { id: "p5", name: "Mechanical Keyboard", price: 75.00, info: "Brown switches, Backlit." }
    ];

    let user = null;
    const cartChannel = new BroadcastChannel('shop_cart_channel');

    window.addP = async (id) => {
      if (!user || !user.emailVerified) return alert("Please Login & Verify Email first!");
      const p = products.find(x => x.id === id);
      await push(ref(db, `carts/${user.uid}`), p);
    };

    window.remP = async (key) => {
      if (user) await remove(ref(db, `carts/${user.uid}/${key}`));
    };

    window.viewP = (id) => {
      if (id === "p1") {
        // Redirect to your new GitHub Pages item page
        window.open("https://johnessentialsshop.github.io/EssentialsShop/item/Pro-Gaming-RGB-Headset.html", "_blank");
      } else {
        // Fallback for other items
        const p = products.find(x => x.id === id);
        const win = window.open("", "_blank");
        win.document.body.innerHTML = `<div style="font-family:sans-serif;text-align:center;padding:50px;"><h1>${p.name}</h1><h2>$${p.price.toFixed(2)}</h2><p>${p.info}</p><button id="addBtn" style="padding:15px 30px;background:#0077cc;color:#fff;border:none;border-radius:8px;cursor:pointer;">Add to Cart & Close</button></div>`;
        win.document.getElementById('addBtn').onclick = () => {
          cartChannel.postMessage({ action: 'add', productId: id });
          win.close();
        };
      }
    };

    cartChannel.onmessage = (event) => {
      if (event.data.action === 'add') window.addP(event.data.productId);
    };

    onAuthStateChanged(auth, (u) => {
      user = u;
      document.getElementById("status").textContent = u ? (u.emailVerified ? u.email : "Verify Email") : "Guest";
      document.getElementById("signupBtn").style.display = u ? "none" : "block";
      document.getElementById("outBtn").style.display = u ? "block" : "none";
      if (u?.emailVerified) syncCart(u.uid);
    });

    const grid = document.getElementById("grid");
    products.forEach(p => {
      const d = document.createElement("div");
      d.className = "card";
      d.onclick = () => window.viewP(p.id);
      d.innerHTML = `
        <div style="font-weight:700;">${p.name}</div>
        <div style="color:#0077cc; font-weight:700;">$${p.price.toFixed(2)}</div>
        <button class="btn btn-primary" onclick="event.stopPropagation(); window.addP('${p.id}')">Quick Add</button>
      `;
      grid.appendChild(d);
    });

    function syncCart(uid) {
      onValue(ref(db, `carts/${uid}`), (snap) => {
        const data = snap.val() || {};
        const entries = Object.entries(data);
        document.getElementById("count").textContent = entries.length;
        const list = document.getElementById("list");
        list.innerHTML = "";
        let total = 0;
        entries.forEach(([key, val]) => {
          total += val.price;
          list.innerHTML += `<div class="cart-row"><span>${val.name}</span><span>$${val.price.toFixed(2)} <button class="btn-danger" onclick="window.remP('${key}')">Remove</button></span></div>`;
        });
        document.getElementById("total").textContent = "Total: $" + total.toFixed(2);
      });
    }

    document.getElementById("signupBtn").onclick = () => document.getElementById("authM").style.display = "flex";
    document.getElementById("outBtn").onclick = () => signOut(auth);
    document.getElementById("viewCart").onclick = () => document.getElementById("cartM").style.display = "flex";
    document.getElementById("checkoutBtn").onclick = () => {
      const prank = window.open("", "_blank");
      prank.document.body.innerHTML = "<div style='font-family:sans-serif;text-align:center;padding:100px;'><h1 style='font-size:50px;'>GET PRANKED! ðŸ¤¡</h1></div>";
    };

    document.getElementById("doAuth").onclick = async () => {
      const e = document.getElementById("email").value;
      const p = document.getElementById("pass").value;
      try {
        const res = await signInWithEmailAndPassword(auth, e, p).catch(() => createUserWithEmailAndPassword(auth, e, p));
        if (res.user && !res.user.emailVerified) {
          await sendEmailVerification(res.user);
          alert("Check your email to verify!");
        }
        document.getElementById("authM").style.display = "none";
      } catch (err) { alert(err.message); }
    };
  </script>
</body>
</html>
