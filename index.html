<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PorkEssentials Shop</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f8;
      margin: 0;
      padding: 0;
    }
    header {
      background: #ffffff;
      border-bottom: 1px solid #ddd;
      padding: 15px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .brand {
      font-size: 22px;
      font-weight: 600;
      color: #333;
    }
    .header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 14px;
      transition: 0.2s;
    }
    .btn-primary {
      background: #0077cc;
      color: #fff;
    }
    .btn-primary:hover {
      background: #005fa3;
    }
    .btn-outline {
      background: #fff;
      color: #0077cc;
      border: 1px solid #0077cc;
    }
    .btn-outline:hover {
      background: #e6f2fb;
    }
    .cart-indicator {
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }
    .cart-count {
      background: #ff4d4f;
      color: #fff;
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 12px;
      min-width: 20px;
      text-align: center;
    }
    main {
      padding: 25px;
    }
    h2 {
      margin-top: 0;
      color: #333;
    }
    .shop-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 20px;
    }
    .item {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      width: 250px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .item-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    .item-price {
      color: #0077cc;
      font-size: 16px;
      margin-bottom: 4px;
    }
    .item-stock {
      color: #cc0000;
      font-size: 13px;
      margin-bottom: 10px;
    }
    .item-actions {
      margin-top: 10px;
      display: flex;
      justify-content: flex-end;
    }

    /* Modals */
    .modal {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: #fff;
      padding: 20px 22px;
      width: 360px;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      position: relative;
    }
    .modal h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }
    .close {
      position: absolute;
      right: 12px;
      top: 8px;
      font-size: 20px;
      cursor: pointer;
      color: #888;
    }
    label {
      display: block;
      font-size: 13px;
      margin-top: 10px;
      margin-bottom: 4px;
      color: #444;
    }
    input {
      width: 100%;
      padding: 9px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
      box-sizing: border-box;
    }
    .modal-footer {
      margin-top: 15px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* Cart modal */
    .cart-list {
      max-height: 260px;
      overflow-y: auto;
      margin-top: 10px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }
    .cart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 0;
      border-bottom: 1px solid #f1f1f1;
      font-size: 14px;
    }
    .cart-item-name {
      font-weight: 500;
    }
    .cart-item-meta {
      font-size: 13px;
      color: #555;
    }
    .cart-empty {
      font-size: 14px;
      color: #777;
      margin-top: 10px;
    }
    .cart-footer {
      margin-top: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-total {
      font-weight: 600;
      color: #333;
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">PorkEssentials</div>
    <div class="header-right">
      <div id="userStatus" style="font-size: 13px; color:#555;">Not signed in</div>
      <div class="cart-indicator" id="openCart">
        <span>Cart</span>
        <span class="cart-count" id="cartCount">0</span>
      </div>
      <button class="btn btn-outline" id="loginBtn">Login</button>
      <button class="btn btn-primary" id="signupBtn">Sign Up</button>
      <button class="btn btn-outline" id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </header>

  <main>
    <h2>Featured Essentials</h2>
    <div class="shop-container" id="shop"></div>
  </main>

  <!-- SIGNUP MODAL -->
  <div class="modal" id="signupModal">
    <div class="modal-content">
      <span class="close" data-close="signupModal">&times;</span>
      <h3>Create Account</h3>
      <label>Username</label>
      <input type="text" id="signupUsername" />
      <label>Email</label>
      <input type="email" id="signupEmail" />
      <label>Password</label>
      <input type="password" id="signupPassword" />
      <div class="modal-footer">
        <button class="btn btn-outline" data-close="signupModal">Cancel</button>
        <button class="btn btn-primary" id="signupSubmit">Sign Up</button>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL -->
  <div class="modal" id="loginModal">
    <div class="modal-content">
      <span class="close" data-close="loginModal">&times;</span>
      <h3>Login</h3>
      <label>Email</label>
      <input type="email" id="loginEmail" />
      <label>Password</label>
      <input type="password" id="loginPassword" />
      <div class="modal-footer">
        <button class="btn btn-outline" data-close="loginModal">Cancel</button>
        <button class="btn btn-primary" id="loginSubmit">Login</button>
      </div>
    </div>
  </div>

  <!-- CART MODAL -->
  <div class="modal" id="cartModal">
    <div class="modal-content">
      <span class="close" data-close="cartModal">&times;</span>
      <h3>Your Cart</h3>
      <div id="cartList" class="cart-list"></div>
      <div id="cartEmpty" class="cart-empty" style="display:none;">Your cart is empty.</div>
      <div class="cart-footer">
        <div class="cart-total" id="cartTotal">$0.00</div>
        <div>
          <button class="btn btn-outline" id="clearCartBtn">Clear Cart</button>
          <button class="btn btn-primary" id="checkoutBtn">Checkout</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // ---------- Firebase imports ----------
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getAuth,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      sendEmailVerification,
      onAuthStateChanged,
      signOut
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      getDatabase,
      ref,
      push,
      onValue,
      remove,
      get,
      child
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyDx_P6m-wW68dfFfH3Yn8S6H3lXlNDg62g",
      authDomain: "project1-bad96.firebaseapp.com",
      databaseURL: "https://project1-bad96-default-rtdb.firebaseio.com",
      projectId: "project1-bad96",
      storageBucket: "project1-bad96.firebasestorage.app",
      messagingSenderId: "1061798946964",
      appId: "1:1061798946964:web:6d5e24253b4146af522c81",
      measurementId: "G-E6S5VB594P"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // ---------- UI elements ----------
    const shopEl = document.getElementById("shop");
    const signupModal = document.getElementById("signupModal");
    const loginModal = document.getElementById("loginModal");
    const cartModal = document.getElementById("cartModal");
    const loginBtn = document.getElementById("loginBtn");
    const signupBtn = document.getElementById("signupBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const signupSubmit = document.getElementById("signupSubmit");
    const loginSubmit = document.getElementById("loginSubmit");
    const userStatus = document.getElementById("userStatus");
    const cartCountEl = document.getElementById("cartCount");
    const cartListEl = document.getElementById("cartList");
    const cartEmptyEl = document.getElementById("cartEmpty");
    const cartTotalEl = document.getElementById("cartTotal");
    const openCartBtn = document.getElementById("openCart");
    const clearCartBtn = document.getElementById("clearCartBtn");
    const checkoutBtn = document.getElementById("checkoutBtn");

    let currentUser = null;
    let cartListenerRef = null;

    // ---------- Items ----------
    const items = [
      { id: "hoodie", name: "Essential Hoodie", price: 40.99, stock: "Only 4 left in stock" },
      { id: "mug", name: "PorkEssentials Mug", price: 12.49, stock: "Only 2 left in stock" },
      { id: "tote", name: "Minimalist Tote Bag", price: 18.99, stock: "Only 6 left in stock" },
      { id: "usb", name: "OinkTech USB Drive", price: 9.99, stock: "Only 1 left in stock" },
      { id: "notebook", name: "PorkEssentials Notebook", price: 7.49, stock: "Only 3 left in stock" }
    ];

    function renderItems() {
      shopEl.innerHTML = "";
      items.forEach(item => {
        const div = document.createElement("div");
        div.className = "item";
        div.innerHTML = `
          <div>
            <div class="item-title">${item.name}</div>
            <div class="item-price">$${item.price.toFixed(2)}</div>
            <div class="item-stock">${item.stock}</div>
          </div>
          <div class="item-actions">
            <button class="btn btn-primary" data-add="${item.id}">Add to Cart</button>
          </div>
        `;
        shopEl.appendChild(div);
      });
    }

    renderItems();

    // ---------- Modal helpers ----------
    function openModal(id) {
      const m = document.getElementById(id);
      if (m) m.style.display = "flex";
    }
    function closeModal(id) {
      const m = document.getElementById(id);
      if (m) m.style.display = "none";
    }

    document.addEventListener("click", (e) => {
      const closeTarget = e.target.getAttribute("data-close");
      if (closeTarget) {
        closeModal(closeTarget);
      }
      if (e.target.classList.contains("close")) {
        const id = e.target.getAttribute("data-close");
        if (id) closeModal(id);
      }
    });

    // ---------- Auth handlers ----------
    signupBtn.addEventListener("click", () => openModal("signupModal"));
    loginBtn.addEventListener("click", () => openModal("loginModal"));

    signupSubmit.addEventListener("click", async () => {
      const username = document.getElementById("signupUsername").value.trim();
      const email = document.getElementById("signupEmail").value.trim();
      const password = document.getElementById("signupPassword").value;

      if (!username || !email || !password) {
        alert("Please fill out all fields.");
        return;
      }

      try {
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        await sendEmailVerification(cred.user);
        alert("Account created. A verification email has been sent. Please verify before logging in.");
        closeModal("signupModal");
      } catch (err) {
        alert("Sign up error: " + err.message);
      }
    });

    loginSubmit.addEventListener("click", async () => {
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      if (!email || !password) {
        alert("Please enter email and password.");
        return;
      }

      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        if (!cred.user.emailVerified) {
          await signOut(auth);
          alert("Please verify your email before logging in.");
          return;
        }
        closeModal("loginModal");
      } catch (err) {
        alert("Login error: " + err.message);
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      if (user && user.emailVerified) {
        userStatus.textContent = `Signed in as ${user.email}`;
        loginBtn.style.display = "none";
        signupBtn.style.display = "none";
        logoutBtn.style.display = "inline-block";
        attachCartListener();
      } else {
        userStatus.textContent = "Not signed in";
        loginBtn.style.display = "inline-block";
        signupBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        detachCartListener();
        cartCountEl.textContent = "0";
        cartListEl.innerHTML = "";
        cartTotalEl.textContent = "$0.00";
        cartEmptyEl.style.display = "block";
      }
    });

    // ---------- Cart logic ----------
    function attachCartListener() {
      if (!currentUser) return;
      const cartRef = ref(db, "carts/" + currentUser.uid);
      cartListenerRef = cartRef;
      onValue(cartRef, (snapshot) => {
        const data = snapshot.val() || {};
        const entries = Object.entries(data);
        const count = entries.length; // Option A: count all entries
        cartCountEl.textContent = count.toString();

        cartListEl.innerHTML = "";
        let total = 0;
        if (entries.length === 0) {
          cartEmptyEl.style.display = "block";
        } else {
          cartEmptyEl.style.display = "none";
        }

        entries.forEach(([key, value]) => {
          const price = value.price || 0;
          total += price;
          const row = document.createElement("div");
          row.className = "cart-item";
          row.innerHTML = `
            <div>
              <div class="cart-item-name">${value.name || "Item"}</div>
              <div class="cart-item-meta">$${price.toFixed(2)}</div>
            </div>
            <button class="btn btn-outline" data-remove="${key}">Remove</button>
          `;
          cartListEl.appendChild(row);
        });

        cartTotalEl.textContent = "$" + total.toFixed(2);
      });
    }

    function detachCartListener() {
      if (cartListenerRef) {
        // onValue with same ref and no callback can't detach in modular easily;
        // simplest: rely on auth change resetting UI; listener stops when page reloads.
        cartListenerRef = null;
      }
    }

    shopEl.addEventListener("click", async (e) => {
      const id = e.target.getAttribute("data-add");
      if (!id) return;
      if (!currentUser) {
        alert("Please log in and verify your email before adding items to cart.");
        return;
      }
      const item = items.find(i => i.id === id);
      if (!item) return;

      const cartRef = ref(db, "carts/" + currentUser.uid);
      try {
        await push(cartRef, {
          itemId: item.id,
          name: item.name,
          price: item.price,
          addedAt: Date.now()
        });
      } catch (err) {
        alert("Error adding to cart: " + err.message);
      }
    });

    cartListEl.addEventListener("click", async (e) => {
      const key = e.target.getAttribute("data-remove");
      if (!key || !currentUser) return;
      const itemRef = ref(db, "carts/" + currentUser.uid + "/" + key);
      try {
        await remove(itemRef);
      } catch (err) {
        alert("Error removing item: " + err.message);
      }
    });

    openCartBtn.addEventListener("click", () => {
      if (!currentUser) {
        alert("Please log in to view your cart.");
        return;
      }
      openModal("cartModal");
    });

    clearCartBtn.addEventListener("click", async () => {
      if (!currentUser) return;
      const cartRef = ref(db, "carts/" + currentUser.uid);
      try {
        const snap = await get(cartRef);
        if (snap.exists()) {
          const data = snap.val();
          const updates = {};
          Object.keys(data).forEach(k => {
            updates["carts/" + currentUser.uid + "/" + k] = null;
          });
          // Remove each entry
          for (const k of Object.keys(data)) {
            await remove(ref(db, "carts/" + currentUser.uid + "/" + k));
          }
        }
      } catch (err) {
        alert("Error clearing cart: " + err.message);
      }
    });

    checkoutBtn.addEventListener("click", () => {
      // Redirect to example.com on checkout
      window.location.href = "https://example.com";
    });

    // Close modals when clicking outside
    [signupModal, loginModal, cartModal].forEach(modal => {
      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });
    });
  </script>
</body>
</html>
